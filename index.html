<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeoMeoBot</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <h2 class="app-title">
            <img src="assets/icon.png" alt="App Icon" class="app-icon">
            <span>MeoMeoBot</span>
        </h2>
        <div class="header-right">
            
            <div id="updateStatus" class="status checking">
                <span class="status-dot"></span>
                <span class="update-text-label">V√©rification...</span>
                
                <div id="update-action-container" class="hidden">
                    <span id="update-confirm-icon" class="update-icon confirm-icon" title="Cliquer pour t√©l√©charger/installer">üì•</span>
                    <span id="update-deny-icon" class="update-icon deny-icon" title="Refuser/Annuler">‚ùå</span>
                </div>
            </div>

            <div id="connectionStatus" class="status disconnected">
                <span class="status-dot"></span>
                <span>D√©connect√©</span>
            </div>
            <div class="window-controls">
                <div class="control-btn" id="minimize-btn" title="Minimiser"><svg width="12" height="12" viewBox="0 0 12 12"><path d="M1 5.5h10v1H1z"></path></svg></div>
                <div class="control-btn" id="maximize-btn" title="Agrandir"><svg width="12" height="12" viewBox="0 0 12 12"><path d="M2.5 2.5h7v7h-7zM1 1v10h10V1H1z"></path></svg></div>
                <div class="control-btn" id="close-btn" title="Fermer"><svg width="12" height="12" viewBox="0 0 12 12"><path d="M2.22 2.22l7.56 7.56m-7.56 0l7.56-7.56"></path></svg></div>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="main-tabs">
            <div class="tab active" data-tab="commands">Commandes</div>
            <div class="tab" data-tab="giveaway">Giveaway</div>
            <div class="tab" data-tab="moderation">Mod√©ration</div>
            <div class="tab" data-tab="cast">Cast</div>
            <div class="tab" data-tab="widgets">Widgets</div>
        </div>
        <div class="settings-tab">
            <div class="tab icon-tab" data-tab="config" title="Configuration">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </div>
        </div>
    </div>

    <div class="tab-content active" id="commands-tab">
        <div class="card full-height-card">
            <div class="interactive-header">
                <div class="header-main-controls">
                    <div class="form-group">
                        <label>Commande</label>
                        <input type="text" id="newCommand" placeholder="discord, twitter...">
                    </div>
                    <div class="form-group flex-grow">
                        <label>R√©ponse</label>
                        <input type="text" id="commandResponse" placeholder="Message de r√©ponse">
                    </div>
                    <button class="btn btn-primary" id="addCommandBtn">Ajouter</button>
                </div>
            </div>
            <div class="list-container" id="commandsList"></div>
        </div>
    </div>

    <div class="tab-content" id="giveaway-tab">
        <div class="giveaway-layout">
            <div class="giveaway-config">
                <div class="card full-height-card">
                    <h3 class="card-title">Configuration</h3>
                    <div class="form-group">
                        <label>Commande</label>
                        <input type="text" id="giveawayCommand" value="!giveaway">
                    </div>
                    <div class="form-group">
                        <label>Message de d√©marrage</label>
                        <textarea id="giveawayStartMessage" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Message de fermeture</label>
                        <textarea id="giveawayStopMessage" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Message de victoire ({winner})</label>
                        <textarea id="giveawayWinMessage" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary form-button" id="saveGiveawayConfig">Sauvegarder</button>
                </div>
            </div>
            <div class="giveaway-main">
                <div class="control-bar">
                    <button class="btn btn-success" id="startGiveawayBtn">D√©marrer</button>
                    <button class="btn btn-danger" id="stopGiveawayBtn">Arr√™ter</button>
                    <button class="btn btn-primary" id="drawWinnerBtn">Tirer un Gagnant</button>
                    <button class="btn btn-secondary" id="clearParticipantsBtn">Vider la Liste</button>
                </div>
                <div class="card full-height-card">
                    <div class="winner-display" id="winnerDisplay">Pr√™t pour le tirage</div>
                    <div class="card-header">
                        <h3 class="card-title">Participants</h3>
                        <span class="participant-count" id="participantsCount">0</span>
                    </div>
                    <div class="list-container" id="participantsList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="moderation-tab">
        <div class="moderation-layout">
            <div class="card full-height-card">
                <div class="interactive-header">
                    <div class="header-main-controls">
                        <div class="form-group flex-grow">
                            <label>Mot ou expression √† bannir</label>
                            <input type="text" id="newBannedWord" placeholder="Mot √† bannir">
                        </div>
                        <button class="btn btn-primary" id="addBannedWordBtn">Ajouter</button>
                    </div>
                    <button id="clearBannedWordsBtn" class="btn-link">Vider la liste</button>
                </div>
                <div class="list-container" id="bannedWordsList"></div>
            </div>
             <div class="moderation-settings-col">
                <div class="card">
                    <h3 class="card-title">Message Automatique</h3>
                    <div class="form-group">
                        <label>Message (laisser vide pour d√©sactiver)</label>
                        <textarea id="autoMessage" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Intervalle (messages)</label>
                        <input type="number" id="autoMessageInterval" value="40" min="1">
                    </div>
                    <button class="btn btn-primary form-button" id="saveAutoMessage">Sauvegarder</button>
                </div>
                 
                <div class="card">
                    <h3 class="card-title">Commande !clip</h3>
                    <div class="form-group">
                        <label>Cooldown de la commande (secondes)</label>
                        <input type="number" id="clipCooldown" value="60" min="10">
                    </div>
                    <button class="btn btn-primary form-button" id="saveClipConfig">Sauvegarder Clip</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="cast-tab">
        <div class="card full-height-card">
            <div class="list-container" id="video-thumbnail-grid"></div>
            <button class="fab" id="select-cast-folder-btn" title="Choisir un dossier">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
            </button>
        </div>
    </div>

    <div class="tab-content" id="widgets-tab">
        <div class="card full-height-card">
            <h3 class="card-title">Configuration des Widgets</h3>
            <p>URL du Serveur Local: <code id="widgetUrlDisplay">Chargement...</code></p>
            
            <h4 style="margin-top: 15px;">Widgets Disponibles:</h4>
            <div class="list-item" data-widget="chat">
                <div class="content"><strong>Chat Overlay</strong></div>
                <div class="controls" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <label><input type="checkbox" data-badge="moderator">Mod</label>
                    <label><input type="checkbox" data-badge="vip">VIP</label>
                    <label><input type="checkbox" data-badge="subscriber">Sub</label>
                    <label><input type="checkbox" data-badge="founder">Founder</label>
                    <label><input type="checkbox" data-badge="partner">Partner</label>
                    <label><input type="checkbox" data-badge="staff">Staff</label>
                    <label><input type="checkbox" data-badge="premium">Prime</label>
                    <button class="btn btn-secondary btn-sm" onclick="editWidgetCss('chat')">√âditer CSS</button>
                    <button class="btn btn-primary btn-sm" id="saveBadgePrefs" title="Sauvegarder">üíæ</button>
                </div>
             </div>
        </div>
    </div>

    <div class="tab-content" id="config-tab">
        <div class="card login-card">
            <h3 class="card-title">Connexion √† Twitch</h3>
            <div class="form-group">
                <label>Canal Twitch (votre cha√Æne)</label>
                <input type="text" id="channelName">
            </div>
            <div class="form-group">
                <label>Nom du bot</label>
                <input type="text" id="botUsername">
            </div>
            <div class="form-group">
                <label>Token OAuth</label>
                <input type="password" id="oauthToken">
            </div>
            <div class="unified-button-row">
                <button class="btn btn-primary" id="saveConfigBtn">Sauvegarder</button>
                <button class="btn btn-success" id="connectBtn">Connecter</button>
                <button class="btn btn-danger" id="disconnectBtn">D√©connecter</button>
            </div>
        </div>
    </div>

    <div id="device-picker-overlay" class="confirmation-overlay">
         <div class="device-picker-box">
            <h4 id="device-discovery-status">Recherche des appareils...</h4>
            <div id="device-list"></div>
            <div class="confirmation-buttons">
                <button class="btn btn-secondary" id="close-device-picker">Annuler</button>
            </div>
        </div>
    </div>

    <div id="confirmationOverlay" class="confirmation-overlay">
         <div class="confirmation-box">
            <h4 id="confirmationMessage">√ätes-vous s√ªr ?</h4>
            <div class="confirmation-buttons">
                <button class="btn btn-danger" id="confirmYes">Oui</button>
                <button class="btn btn-secondary" id="confirmNo">Non</button>
            </div>
        </div>
    </div>
    <div id="notification-container"></div>

    <script>
        let activeInlineEdit = null;
        let pendingAction = null;
        let currentVideoToCast = null;

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            setupTabs();
            await loadAllData();
            await loadBadgePrefs();
            setupEventListeners();
            setupConfirmationOverlay(); 
            updateUpdaterStatus('checking');
            window.api.invoke('get-widget-url').then(url => {
                document.getElementById('widgetUrlDisplay').textContent = url;
            });
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.classList.contains('active')) return;
                    document.querySelector('.tab.active').classList.remove('active');
                    const activeContent = document.querySelector('.tab-content.active');
                    if(activeContent) activeContent.classList.remove('active');
                    
                    tab.classList.add('active');
                    const newContent = document.getElementById(`${tab.dataset.tab}-tab`);
                    if(newContent) newContent.classList.add('active');
                });
            });
        }

        async function loadAllData() {
            try {
                const config = await window.api.invoke('get-config');
                updateConfigForm(config);
                if (config.castFolderPath) {
                    await loadCastVideos(config.castFolderPath); 
                }
                await loadCommands();
                await loadBannedWords();
                await loadParticipants();
            } catch (error) {
                showNotification(`Erreur critique au chargement: ${error.message || error}`, "error");
            }
        }
        
        function setupEventListeners() {
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfig);
            document.getElementById('connectBtn').addEventListener('click', connectBot);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectBot);
            document.getElementById('saveAutoMessage').addEventListener('click', saveAutoMessage);
            document.getElementById('saveClipConfig').addEventListener('click', saveClipConfig);
            document.getElementById('saveBadgePrefs').addEventListener('click', saveBadgePrefs);
            const saveBadgeBtn = document.getElementById('saveBadgePrefs');
            if (saveBadgeBtn) saveBadgeBtn.addEventListener('click', saveBadgePrefs);


            
            const addCommandBtn = document.getElementById('addCommandBtn');
            const newCommandInput = document.getElementById('newCommand');
            const commandResponseInput = document.getElementById('commandResponse');
            addCommandBtn.addEventListener('click', addCommand);
            newCommandInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') commandResponseInput.focus(); });
            commandResponseInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addCommand(); }});
            
            document.getElementById('saveGiveawayConfig').addEventListener('click', saveGiveawayConfig);
            document.getElementById('startGiveawayBtn').addEventListener('click', startGiveaway);
            document.getElementById('stopGiveawayBtn').addEventListener('click', stopGiveaway);
            document.getElementById('drawWinnerBtn').addEventListener('click', drawWinner);
            document.getElementById('clearParticipantsBtn').addEventListener('click', () => showConfirmation('Vider la liste des participants ?', clearParticipants));
            
            const addBannedWordBtn = document.getElementById('addBannedWordBtn');
            const newBannedWordInput = document.getElementById('newBannedWord');
            addBannedWordBtn.addEventListener('click', addBannedWord);
            newBannedWordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addBannedWord(); } });
            document.getElementById('clearBannedWordsBtn').addEventListener('click', () => {
                showConfirmation('Vider toute la liste des mots bannis ? Cette action est irr√©versible.', clearBannedWords);
            });
            
            document.getElementById('select-cast-folder-btn').addEventListener('click', selectCastFolder);
            document.getElementById('close-device-picker').addEventListener('click', hideDevicePicker);
            
            document.getElementById('minimize-btn').addEventListener('click', () => window.api.send('window-control', 'minimize'));
            document.getElementById('maximize-btn').addEventListener('click', () => window.api.send('window-control', 'maximize'));
            document.getElementById('close-btn').addEventListener('click', () => window.api.send('window-control', 'close'));

            const updateStatus = document.getElementById('updateStatus');
            const updateConfirmIcon = document.getElementById('update-confirm-icon');
            const updateDenyIcon = document.getElementById('update-deny-icon');

            updateStatus.addEventListener('click', (e) => {
                if (!e.target.closest('.update-popover') && (updateStatus.classList.contains('update-available') || updateStatus.classList.contains('downloaded'))) {
                     updateStatus.classList.toggle('active');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!updateStatus.contains(e.target)) {
                    updateStatus.classList.remove('active');
                }
            });

            updateConfirmIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                if (updateStatus.classList.contains('update-available')) {
                    window.api.send('start-download');
                } else if (updateStatus.classList.contains('downloaded')) {
                    window.api.send('quit-and-install');
                }
            });

            updateDenyIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                updateUpdaterStatus('up-to-date'); 
                showNotification('Mise √† jour refus√©e pour le moment.', 'info');
            });
            
            window.editWidgetCss = function(widgetName) {
            window.api.invoke('open-css-editor', widgetName || 'chat');
          };

        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        function setupConfirmationOverlay() {
            const overlay = document.getElementById('confirmationOverlay');
            document.getElementById('confirmYes').addEventListener('click', () => {
                if (pendingAction) pendingAction();
                hideConfirmation();
            });
            document.getElementById('confirmNo').addEventListener('click', hideConfirmation);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) hideConfirmation(); });
        }
        function showConfirmation(message, action) {
            document.getElementById('confirmationMessage').textContent = message;
            pendingAction = action;
            document.getElementById('confirmationOverlay').classList.add('active');
        }
        function hideConfirmation() {
            document.getElementById('confirmationOverlay').classList.remove('active');
            pendingAction = null;
        }

        function startCommandEdit(commandName) {
            if (activeInlineEdit) cancelCommandEdit(activeInlineEdit);
            const item = document.querySelector(`.list-item[data-command="${commandName}"]`);
            if (!item) return;
            activeInlineEdit = commandName;
            const content = item.querySelector('.content');
            const controls = item.querySelector('.controls');
            const commandToEdit = item.dataset.command.substring(1);
            const response = item.dataset.response;
            content.innerHTML = `
                <span style="color: var(--accent); font-weight: bold; font-size: 1.2em;">!</span>
                <input class="inline-input" id="inline-edit-command" type="text" value="${commandToEdit}" style="width: 150px; flex-shrink: 0;">
                <input class="inline-input" id="inline-edit-response" type="text" value="${response}" style="flex-grow: 1;">
            `;
            controls.innerHTML = `
                <button class="control-button" onclick="saveCommandEdit('${commandName}')" title="Sauvegarder">‚úÖ</button>
                <button class="control-button" onclick="cancelCommandEdit('${commandName}')" title="Annuler">‚ùå</button>
            `;
            item.querySelector('#inline-edit-response').focus();
        }
        async function saveCommandEdit(originalCommandName) {
            const item = document.querySelector(`.list-item[data-command="${originalCommandName}"]`);
            let newCommand = item.querySelector('#inline-edit-command').value.trim().replace(/^!+/, '');
            const newResponse = item.querySelector('#inline-edit-response').value.trim();
            if (!newCommand || !newResponse) {
                showNotification('La commande et la r√©ponse ne peuvent pas √™tre vides.', 'error');
                return;
            }
            const finalCommand = '!' + newCommand;
            if (originalCommandName !== finalCommand) {
                await window.api.invoke('remove-command', originalCommandName);
            }
            await window.api.invoke('add-command', finalCommand, response);
            activeInlineEdit = null;
            await loadCommands();
            showNotification('Commande modifi√©e !', 'success');
        }
        function cancelCommandEdit(commandName) {
            activeInlineEdit = null;
            loadCommands();
        }
        function confirmDelete(element, type, id) {
            const item = element.closest('.list-item');
            item.classList.add('is-deleting');
            const confirmControls = item.querySelector('.inline-confirm');
            confirmControls.innerHTML = `
                <span>Supprimer ?</span>
                <button class="control-button" onclick="${type}Delete('${id.replace(/'/g, `\\'`)}')">‚úÖ</button>
                <button class="control-button" onclick="cancelDelete(this)">‚ùå</button>
            `;
        }
        function cancelDelete(element) {
            const item = element.closest('.list-item');
            item.classList.remove('is-deleting');
        }

        async function loadCommands() {
            const result = await window.api.invoke('get-commands');
            const list = document.getElementById('commandsList');
            list.innerHTML = '';
            for (const [command, response] of Object.entries(result.commands)) {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.dataset.command = command;
                item.dataset.response = response;
                item.innerHTML = `
                    <div class="content">
                        <strong style="color: var(--accent); width: 150px; flex-shrink: 0; word-break: break-all;">${command}</strong>
                        <span style="color: var(--text-secondary);">${response}</span>
                    </div>
                    <div class="controls">
                        <button class="control-button" onclick="startCommandEdit('${command.replace(/'/g, `\\'`)}')" title="√âditer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="control-button" onclick="confirmDelete(this, 'command', '${command.replace(/'/g, `\\'`)}')" title="Supprimer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                    <div class="inline-confirm"></div>
                `;
                list.appendChild(item);
            }
        }
        async function loadBadgePrefs() {
            const cfg = await window.api.invoke('get-widget-config', 'chat');
            const prefs = (cfg && cfg.badgePrefs) || {};
            document.querySelectorAll('#widgetList input[data-badge]').forEach(inp => {
                const key = inp.dataset.badge;
                inp.checked = prefs[key] !== false;
            });
        }
        async function saveBadgePrefs() {
            const prefs = {};
            document.querySelectorAll('#widgetList input[data-badge]').forEach(inp => {
                prefs[inp.dataset.badge] = inp.checked;
            });
            await window.api.invoke('save-widget-config', 'chat', { badgePrefs: prefs });
            showNotification('Badges mis √† jour', 'success');
        }
        async function commandDelete(command) {
            await window.api.invoke('remove-command', command);
            await loadCommands();
            showNotification(`Commande ${command} supprim√©e.`, 'info');
        }
        async function loadBannedWords() {
            const { bannedWords } = await window.api.invoke('get-banned-words');
            const list = document.getElementById('bannedWordsList');
            list.innerHTML = '';
            (bannedWords || []).forEach(word => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="content"><span>${word}</span></div>
                    <div class="controls">
                        <button class="control-button" onclick="confirmDelete(this, 'bannedWord', '${word.replace(/'/g, `\\'`)}')" title="Supprimer">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                    <div class="inline-confirm"></div>
                `;
                list.appendChild(item);
            });
        }
        async function bannedWordDelete(word) {
            await window.api.invoke('remove-banned-word', word);
            await loadBannedWords();
            showNotification(`Mot "${word}" supprim√©.`, 'info');
        }
        async function clearBannedWords() {
            await window.api.invoke('clear-banned-words');
            await loadBannedWords();
            showNotification('La liste des mots bannis a √©t√© vid√©e.', 'info');
        }
        async function loadParticipants() {
            const { count, participants } = await window.api.invoke('get-participants-count');
            document.getElementById('participantsCount').textContent = count;
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            if (participants && participants.length > 0) {
                participants.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `<div class="content"><span>${p}</span></div>`;
                    list.appendChild(item);
                });
            }
        }
        
        function selectCastFolder() {
            const folderPath = window.api.invoke('select-folder');
            if (folderPath) {
                window.api.invoke('update-config', { castFolderPath: folderPath });
                loadCastVideos(folderPath);
            }
        }
        async function loadCastVideos(folderPath) {
            const grid = document.getElementById('video-thumbnail-grid');
            grid.innerHTML = '<p>Chargement des miniatures, veuillez patienter...</p>';
            try {
                const result = await window.api.invoke('get-videos', folderPath);
                if (result.error) { throw new Error(result.error); }
                grid.innerHTML = '';
                if (!result || result.length === 0) {
                    grid.innerHTML = '<p>Aucune vid√©o compatible trouv√©e ou les miniatures n\'ont pas pu √™tre g√©n√©r√©es.</p>';
                    return;
                }
                result.forEach(video => {
                    const thumbElement = document.createElement('div');
                    thumbElement.className = 'video-thumbnail';
                    thumbElement.title = video.fileName;
                    thumbElement.innerHTML = `<img src="${video.thumbnailData}" alt="${video.fileName}">`;
                    thumbElement.addEventListener('click', () => handleThumbnailClick(video.videoPath));
                    grid.appendChild(thumbElement);
                });
            } catch (error) {
                console.error("Erreur dans loadCastVideos (c√¥t√© rendu):", error);
                grid.innerHTML = `<p style="color: var(--danger);">Erreur lors de la g√©n√©ration des miniatures. V√©rifiez la console du terminal (o√π vous lancez 'npm start') pour les d√©tails.</p>`;
                showNotification(`Erreur FFmpeg. Voir la console.`, "error");
            }
        }
        function handleThumbnailClick(videoPath) {
            currentVideoToCast = videoPath;
            showDevicePicker();
            window.api.invoke('discover-devices');
        }
        function showDevicePicker() {
            document.getElementById('device-list').innerHTML = '';
            document.getElementById('device-discovery-status').textContent = 'Recherche en cours...';
            document.getElementById('device-picker-overlay').classList.add('active');
        }
        function hideDevicePicker() {
            document.getElementById('device-picker-overlay').classList.remove('active');
            currentVideoToCast = null;
        }
        async function playOnDevice(deviceHost, devicePort) {
            if (currentVideoToCast) {
                showNotification(`Lancement de la vid√©o...`);
                await window.api.invoke('play-on-device', { deviceHost, devicePort, videoPath: currentVideoToCast });
                hideDevicePicker();
            }
        }

        function updateConfigForm(config) {
            document.getElementById('channelName').value = config.channel || '';
            document.getElementById('botUsername').value = config.username || '';
            document.getElementById('oauthToken').value = config.token || '';
            document.getElementById('autoMessage').value = config.autoMessage || '';
            document.getElementById('autoMessageInterval').value = config.autoMessageInterval || 40;
            document.getElementById('clipCooldown').value = config.clipCooldown || 60;
            document.getElementById('giveawayCommand').value = config.giveawayCommand || '!giveaway';
            document.getElementById('giveawayStartMessage').value = config.giveawayStartMessage || '';
            document.getElementById('giveawayStopMessage').value = config.giveawayStopMessage || '';
            document.getElementById('giveawayWinMessage').value = config.giveawayWinMessage || '';
        }
        async function saveConfig() {
            await window.api.invoke('update-config', {
                channel: document.getElementById('channelName').value.trim(),
                username: document.getElementById('botUsername').value.trim(),
                token: document.getElementById('oauthToken').value.trim()
            });
            showNotification('Configuration de connexion sauvegard√©e !', 'success');
        }
        async function saveAutoMessage() {
            await window.api.invoke('update-config', {
                autoMessage: document.getElementById('autoMessage').value,
                autoMessageInterval: parseInt(document.getElementById('autoMessageInterval').value)
            });
            showNotification('Message automatique sauvegard√© !', 'success');
        }
        async function saveClipConfig() {
            await window.api.invoke('update-config', {
                clipCooldown: parseInt(document.getElementById('clipCooldown').value)
            });
            showNotification('Configuration du clip sauvegard√©e !', 'success');
        }
        async function saveGiveawayConfig() {
            await window.api.invoke('update-config', {
                giveawayCommand: document.getElementById('giveawayCommand').value,
                giveawayStartMessage: document.getElementById('giveawayStartMessage').value,
                giveawayStopMessage: document.getElementById('giveawayStopMessage').value,
                giveawayWinMessage: document.getElementById('giveawayWinMessage').value
            });
            showNotification('Configuration giveaway sauvegard√©e !', 'success');
        }
        async function addCommand() {
            const commandInput = document.getElementById('newCommand');
            const responseInput = document.getElementById('commandResponse');
            let commandName = commandInput.value.trim().replace(/^!+/, '');
            const response = responseInput.value.trim();
            if (!commandName || !response) {
                showNotification('La commande et la r√©ponse ne peuvent √™tre vides.', 'error');
                return;
            }
            const finalCommand = '!' + commandName;
            await window.api.invoke('add-command', finalCommand, newResponse);
            commandInput.value = '';
            responseInput.value = '';
            await loadCommands();
            showNotification(`Commande ${finalCommand} ajout√©e !`, 'success');
        }
        async function addBannedWord() {
            const input = document.getElementById('newBannedWord');
            const word = input.value.trim();
            if (!word) { showNotification('Veuillez entrer un mot', 'error'); return; }
            await window.api.invoke('add-banned-word', word);
            input.value = '';
            await loadBannedWords();
            showNotification(`Mot "${word}" ajout√© √† la liste.`, 'success');
        }
        async function connectBot() {
            const result = await window.api.invoke('connect-bot');
            if (!result.success) showNotification('Erreur: ' + result.error, 'error');
        }
        async function disconnectBot() { await window.api.invoke('disconnect-bot'); }
        function updateConnectionStatus(connected, channel = '') {
            const statusElement = document.getElementById('connectionStatus');
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            if (connected) {
                statusElement.className = 'status connected';
                statusElement.innerHTML = `<span class="status-dot"></span><span>Connect√© √† ${channel}</span>`;
                if (document.body.dataset.justLaunched !== "true") showNotification(`Bot connect√© √† ${channel} !`, 'success');
            } else {
                statusElement.className = 'status disconnected';
                statusElement.innerHTML = '<span class="status-dot"></span><span>D√©connect√©</span>';
                if (document.body.dataset.justLaunched !== "true") showNotification('Bot d√©connect√© !', 'info');
            }
        }
        document.body.dataset.justLaunched = "true";
        setTimeout(() => document.body.dataset.justLaunched = "false", 2000);

        async function startGiveaway() { await window.api.invoke('start-giveaway'); showNotification('Giveaway d√©marr√© !', 'success'); }
        async function stopGiveaway() { await window.api.invoke('stop-giveaway'); showNotification('Giveaway arr√™t√©.', 'info'); }
        async function drawWinner() {
            const winnerDisplay = document.getElementById('winnerDisplay');
            winnerDisplay.textContent = 'Tirage en cours...';
            const { success, winner } = await window.api.invoke('draw-winner');
            if (success && winner) {
                winnerDisplay.textContent = `üéâ ${winner} üéâ`;
                showNotification(`${winner} a gagn√© le tirage !`, 'success');
            } else {
                winnerDisplay.textContent = 'Aucun participant';
                showNotification('Impossible de tirer un gagnant.', 'error');
            }
        }
        async function clearParticipants() { 
            await window.api.invoke('clear-participants'); 
            await loadParticipants(); 
            showNotification('Liste des participants vid√©e.', 'info');
        }

        function updateUpdaterStatus(status, message = null) {
            const updateStatusElement = document.getElementById('updateStatus');
            const label = updateStatusElement.querySelector('.update-text-label');
            const actionContainer = document.getElementById('update-action-container');

            updateStatusElement.classList.remove('checking', 'update-available', 'up-to-date', 'downloading', 'downloaded', 'error');
            actionContainer.classList.add('hidden'); 
            updateStatusElement.style.cursor = 'default';

            switch (status) {
                case 'checking':
                    updateStatusElement.classList.add('checking');
                    label.textContent = 'V√©rification...';
                    break;
                case 'up-to-date':
                    updateStatusElement.classList.add('up-to-date');
                    label.textContent = '√Ä jour';
                    break;
                case 'update-available':
                    updateStatusElement.classList.add('update-available');
                    label.textContent = 'M√†J dispo';
                    updateStatusElement.style.cursor = 'pointer';
                    actionContainer.classList.remove('hidden'); 
                    document.getElementById('update-confirm-icon').textContent = 'üì•'; 
                    document.getElementById('update-confirm-icon').title = 'Cliquer pour t√©l√©charger';
                    break;
                case 'downloading':
                    updateStatusElement.classList.add('downloading');
                    label.textContent = 'T√©l√©chargement...';
                    break;
                case 'downloaded':
                    updateStatusElement.classList.add('downloaded');
                    updateStatusElement.style.cursor = 'pointer';
                    label.textContent = 'Pr√™t √† installer';
                    actionContainer.classList.remove('hidden'); 
                    document.getElementById('update-confirm-icon').textContent = '‚úÖ'; 
                    document.getElementById('update-confirm-icon').title = 'Cliquer pour red√©marrer et installer';
                    break;
                case 'error':
                    updateStatusElement.classList.add('error'); 
                    label.textContent = 'Erreur M√†J';
                    break;
            }
        }

        window.api.on('bot-status', data => updateConnectionStatus(data.connected, data.channel));
        window.api.on('participants-updated', () => loadParticipants());
        window.api.on('participant-added', () => loadParticipants());
        window.api.on('device-discovery-status', (status) => {
            document.getElementById('device-discovery-status').textContent = status;
        });
        window.api.on('cast-devices-found', (devices) => {
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = '';
            if (!devices || devices.length === 0) {
                deviceList.innerHTML = '<p>Aucun appareil trouv√©.</p>';
            }
            devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                deviceItem.textContent = device.name;
                deviceItem.onclick = () => playOnDevice(device.host, device.port);
                deviceList.appendChild(deviceItem);
            });
        });
        window.api.on('cast-status', ({ success, message }) => {
            showNotification(message, success ? 'success' : 'error');
        });
        
        window.api.on('update-status-check', ({ status, message }) => {
            updateUpdaterStatus(status, message);
        });

        window.api.on('update-available', () => {
            updateUpdaterStatus('update-available');
        });

        window.api.on('update-downloaded', () => {
            updateUpdaterStatus('downloaded');
        });

        window.startCommandEdit = startCommandEdit;
        window.saveCommandEdit = saveCommandEdit;
        window.cancelCommandEdit = cancelCommandEdit;
        window.commandDelete = commandDelete;
        window.bannedWordDelete = bannedWordDelete;
        window.confirmDelete = confirmDelete;
        window.cancelDelete = cancelDelete;
        window.showConfirmation = showConfirmation;
    </script>
</body>
</html>