<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Editeur CSS Widget</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="css-editor-body">
    <div class="css-editor-shell">
        <div class="css-editor-titlebar">
            <h2>Apparence du <span id="widgetNameLabel">tchat</span></h2>
            <button class="css-editor-close" id="close-btn" title="Fermer">✕</button>
        </div>

        <div class="css-editor-main">
            <div class="css-editor-left">
                <div>
                    <label for="customCss">CSS personnalisé</label>
                    <textarea id="customCss" class="css-editor-textarea" spellcheck="false"></textarea>
                </div>
                <div>
                    <label for="maxMessages">Nombre max de messages (chat)</label>
                    <input id="maxMessages" type="number" min="1" value="10">
                </div>
                <div class="css-editor-actions">
                    <button class="btn btn-primary" id="save-btn">Sauvegarder</button>
                    <button class="btn btn-secondary" id="reset-btn">Remettre par défaut</button>
                </div>
                <div class="css-editor-status" id="statusBar"></div>
            </div>

            <div class="css-preview-block">
                <div class="css-preview-toolbar">
                    <span>Aperçu en direct (5 messages simulés)</span>
                </div>
                <div id="preview-frame-wrapper">
                    <iframe id="preview-frame" title="chat preview"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        const defaultCss = {
    chat: `/*
Classes cibles (widget) :
 - body
 - #chat-container
 - .msg-group (wrapper par user) + .user-<username>
 - .msg-header (ligne badges+username)
 - .msg-username
 - .msg-badges
 - .badge-img (img de badge)
 - .msg-messages (pile des messages d'un user)
 - .msg-line (chaque ligne de texte)
Variables dispo :
 - --user-color : couleur twitch de l'user
 - --user-color-soft : version translucide de la couleur user
*/
body { background: transparent; }

#chat-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 12px;
    padding: 10px 10px 24px 10px;
    font-family: "Inter", "Segoe UI", sans-serif;
}

.msg-group {
    padding: 10px 12px;
    background: var(--user-color-soft, rgba(109, 212, 255, 0.12));
    border: 1px solid var(--user-color, #6dd4ff);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    animation: fadeIn 0.4s ease-out;
}

.msg-header {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
}

.msg-username {
    font-weight: 700;
    color: var(--user-color, #6dd4ff);
    letter-spacing: 0.1px;
}

.msg-badges {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.badge-img {
    width: 18px;
    height: 18px;
    object-fit: contain;
}

.msg-messages {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.msg-line {
    color: #e7eef5;
    line-height: 1.4;
}

.msg-line img {
    vertical-align: middle;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
}
`
        };

        let currentWidget = 'chat';
        const cssInput = document.getElementById('customCss');
        const maxMessagesInput = document.getElementById('maxMessages');
        const statusBar = document.getElementById('statusBar');
        const nameLabel = document.getElementById('widgetNameLabel');

        function setStatus(msg, type = '') {
            statusBar.className = `css-editor-status ${type}`;
            statusBar.textContent = msg || '';
        }

        async function loadWidgetConfig(widgetName = 'chat') {
            currentWidget = widgetName || 'chat';
            nameLabel.textContent = currentWidget;
            setStatus('Chargement...');
            try {
                const config = await window.api.invoke('get-widget-config', currentWidget);
                const storedCss = config && typeof config.customCSS === 'string' ? config.customCSS.trim() : '';
                cssInput.value = storedCss || defaultCss[currentWidget] || '';
                maxMessagesInput.value = (config && config.maxMessages) || 10;
                setStatus('Configuration chargée', 'ok');
            } catch (e) {
                cssInput.value = defaultCss[currentWidget] || '';
                maxMessagesInput.value = 10;
                setStatus('Erreur de chargement, valeurs par défaut chargées.', 'err');
            }
        }

        async function saveWidgetConfig() {
            const maxVal = parseInt(maxMessagesInput.value, 10);
            const safeMax = Number.isInteger(maxVal) && maxVal > 0 ? maxVal : 10;
            try {
                await window.api.invoke('save-widget-config', currentWidget, {
                    customCSS: cssInput.value,
                    maxMessages: safeMax
                });
                setStatus('CSS sauvegardé', 'ok');
                renderPreview();
            } catch (e) {
                setStatus('Erreur de sauvegarde: ' + (e.message || e), 'err');
            }
        }

        function getPreviewHtml(customCss, maxMessages) {
            return `<!DOCTYPE html>
<html>
<head>
<style>
body{background:#0a0a0a;margin:0;padding:10px;color:#fff;font-family:Inter,Segoe UI,sans-serif;}
#chat-container{display:flex;flex-direction:column;gap:10px;justify-content:flex-end;}
.message{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);}
.message__meta{display:inline-flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap;}
.username{font-weight:700;margin-right:4px;color:#6dd4ff;}
.message__body{line-height:1.4;}
.badge-img{width:18px;height:18px;object-fit:contain;}
${customCss || ''}
</style>
</head>
<body>
<div id="chat-container"></div>
<script>
const MAX_MESSAGES = ${maxMessages || 10};
const container = document.getElementById('chat-container');
const demo = [
 {u:'Alice',c:'#6dd4ff',b:[{set:'staff',version:'1'}],t:'Hello world!'},
 {u:'Bob',c:'#ff8b3d',b:[{set:'moderator',version:'1'}],t:'Ceci est un test.'},
 {u:'Chloe',c:'#9b59b6',b:[],t:'Nice overlay!'},
 {u:'Dave',c:'#2ecc71',b:[{set:'premium',version:'1'}],t:'Wrap check.'},
 {u:'Eve',c:'#e67e22',b:[],t:'Short msg.'}
];
function add(m){
  const wrap=document.createElement('div');
  wrap.className='message';
  wrap.style.setProperty('--user-color', m.c);
  wrap.style.setProperty('--user-color-soft', 'rgba(255,255,255,0.05)');
  const meta=document.createElement('div');
  meta.className='message__meta';
  const u=document.createElement('span');
  u.className='username';
  u.textContent=m.u;
  u.style.color=m.c;
  meta.appendChild(u);
  (m.b||[]).forEach(b=>{
    const img=document.createElement('img');
    img.className='badge-img';
    img.src='https://static-cdn.jtvnw.net/badges/v1/'+b.set+'/'+b.version+'/1';
    img.alt=b.set;
    img.onerror=()=>img.remove();
    meta.appendChild(img);
  });
  const body=document.createElement('div');
  body.className='message__body';
  body.textContent=m.t;
  wrap.appendChild(meta);
  wrap.appendChild(body);
  container.appendChild(wrap);
}
demo.slice(-MAX_MESSAGES).forEach(add);
<\/script>
</body>
</html>`;
        }

        function renderPreview() {
            const frame = document.getElementById('preview-frame');
            if (!frame) return;
            const css = (cssInput.value || '').trim() || defaultCss[currentWidget] || '';
            const max = parseInt(maxMessagesInput.value, 10) || 10;
            frame.srcdoc = getPreviewHtml(css, max);
        }

        document.getElementById('save-btn').addEventListener('click', saveWidgetConfig);
        document.getElementById('reset-btn').addEventListener('click', () => {
            cssInput.value = defaultCss[currentWidget] || '';
            setStatus('Valeurs par défaut rétablies (pense à sauvegarder)', 'ok');
            renderPreview();
        });
        document.getElementById('close-btn').addEventListener('click', () => window.close());

        cssInput.addEventListener('input', renderPreview);
        maxMessagesInput.addEventListener('input', renderPreview);

        window.api.on('load-css-editor', ({ widgetName }) => { loadWidgetConfig(widgetName).then(renderPreview); });
        document.addEventListener('DOMContentLoaded', () => { loadWidgetConfig().then(renderPreview); });
    </script>
</body>
</html>
