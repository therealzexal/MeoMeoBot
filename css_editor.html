<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Editeur CSS Widget</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="css-editor-body">
    <div class="css-editor-shell">
        <div class="css-editor-titlebar">
            <h2>Apparence du <span id="widgetNameLabel">tchat</span></h2>
            <button class="css-editor-close" id="close-btn" title="Fermer">✕</button>
        </div>

        <div class="css-editor-main">
            <div class="css-editor-left">
                <div>
                    <label for="customCss">CSS personnalisé</label>
                    <textarea id="customCss" class="css-editor-textarea" spellcheck="false"></textarea>
                </div>
                <div>
                    <label for="maxMessages">Nombre max de messages (chat)</label>
                    <input id="maxMessages" type="number" min="1" value="10">
                </div>
                <div class="css-editor-actions">
                    <button class="btn btn-primary" id="save-btn">Sauvegarder</button>
                    <button class="btn btn-secondary" id="reset-btn">Remettre par défaut</button>
                </div>
                <div class="css-editor-status" id="statusBar"></div>
            </div>

            <div class="css-preview-block">
                <div class="css-preview-toolbar">
                    <span>Aperçu en direct (5 messages simulés)</span>
                </div>
                <div id="preview-frame-wrapper">
                    <iframe id="preview-frame" title="chat preview"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        const defaultCss = {
    chat: `/*
Classes cibles (widget) :
 - body
 - #chat-container
 - .msg-group (wrapper par user) + .user-<username>
 - .msg-header (ligne badges+username)
 - .msg-username
 - .msg-badges
 - .badge-img (img de badge)
 - .msg-messages (pile des messages d'un user)
 - .msg-line (chaque ligne de texte)
Variables dispo :
 - --user-color : couleur twitch de l'user
 - --user-color-soft : version translucide de la couleur user
*/
body { background: transparent; }

#chat-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 12px;
    padding: 10px 10px 24px 10px;
    font-family: "Inter", "Segoe UI", sans-serif;
}

.msg-group {
    padding: 10px 12px;
    background: var(--user-color-soft, rgba(109, 212, 255, 0.12));
    border: 1px solid var(--user-color, #6dd4ff);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    animation: fadeIn 0.4s ease-out;
}

.msg-header {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
}

.msg-username {
    font-weight: 700;
    color: var(--user-color, #6dd4ff);
    letter-spacing: 0.1px;
}

.msg-badges {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.badge-img {
    width: 18px;
    height: 18px;
    object-fit: contain;
}

.msg-messages {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.msg-line {
    color: #e7eef5;
    line-height: 1.4;
}

.msg-line img {
    vertical-align: middle;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
}
`
        };

        let currentWidget = 'chat';
        const cssInput = document.getElementById('customCss');
        const maxMessagesInput = document.getElementById('maxMessages');
        const statusBar = document.getElementById('statusBar');
        const nameLabel = document.getElementById('widgetNameLabel');

        function setStatus(msg, type = '') {
            statusBar.className = `css-editor-status ${type}`;
            statusBar.textContent = msg || '';
        }

        async function loadWidgetConfig(widgetName = 'chat') {
            currentWidget = widgetName || 'chat';
            nameLabel.textContent = currentWidget;
            setStatus('Chargement...');
            try {
                const config = await window.api.invoke('get-widget-config', currentWidget);
                const storedCss = config && typeof config.customCSS === 'string' ? config.customCSS.trim() : '';
                cssInput.value = storedCss || defaultCss[currentWidget] || '';
                maxMessagesInput.value = (config && config.maxMessages) || 10;
                setStatus('Configuration chargée', 'ok');
            } catch (e) {
                cssInput.value = defaultCss[currentWidget] || '';
                maxMessagesInput.value = 10;
                setStatus('Erreur de chargement, valeurs par défaut chargées.', 'err');
            }
        }

        async function saveWidgetConfig() {
            const maxVal = parseInt(maxMessagesInput.value, 10);
            const safeMax = Number.isInteger(maxVal) && maxVal > 0 ? maxVal : 10;
            try {
                await window.api.invoke('save-widget-config', currentWidget, {
                    customCSS: cssInput.value,
                    maxMessages: safeMax
                });
                setStatus('CSS sauvegardé', 'ok');
                renderPreview();
            } catch (e) {
                setStatus('Erreur de sauvegarde: ' + (e.message || e), 'err');
            }
        }

        function getPreviewHtml(customCss, maxMessages) {
            return `<!DOCTYPE html>
<html>
<head>
<style>
body{background:#0a0a0a;margin:0;padding:10px;color:#fff;font-family:Inter,Segoe UI,sans-serif;}
#chat-container{display:flex;flex-direction:column;gap:10px;justify-content:flex-end;}
.msg-group{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.08);box-sizing:border-box;}
.msg-header{display:inline-flex;align-items:center;gap:6px;margin-bottom:6px;flex-wrap:wrap;}
.msg-username{font-weight:700;}
.msg-badges{display:inline-flex;align-items:center;gap:4px;}
.badge-img{width:18px;height:18px;object-fit:contain;}
.msg-messages{display:flex;flex-direction:column;gap:4px;}
.msg-line{color:#e7eef5;line-height:1.3;}
${customCss || ''}
</style>
</head>
<body>
<div id="chat-container"></div>
<script>
const MAX_MESSAGES = ${maxMessages || 10};
const container = document.getElementById('chat-container');
const demo = [
 {u:'Alice',c:'#6dd4ff',b:[{set:'staff',version:'1'}],t:'Hello world!'},
 {u:'Bob',c:'#ff8b3d',b:[{set:'moderator',version:'1'}],t:'Ceci est un test.'},
 {u:'Bob',c:'#ff8b3d',b:[{set:'moderator',version:'1'}],t:'Deuxième ligne même user.'},
 {u:'Chloe',c:'#9b59b6',b:[],t:'Nice overlay!'},
 {u:'Eve',c:'#e67e22',b:[],t:'Short msg.'}
];
let lastUser = null;
let lastGroup = null;
function sanitizeClass(str){
  const clean = String(str || '').toLowerCase().replace(/[^a-z0-9_-]+/g,'-').replace(/^-+|-+$/g,'');
  return clean || 'user';
}
function computeColors(hexColor){
  const fallback = '#6dd4ff';
  let c = (hexColor || '').trim();
  if(!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) c = fallback;
  if(c.length === 4) c = '#'+c[1]+c[1]+c[2]+c[2]+c[3]+c[3];
  const r = parseInt(c.slice(1,3),16), g = parseInt(c.slice(3,5),16), b = parseInt(c.slice(5,7),16);
  return { solid:c, soft:'rgba('+r+', '+g+', '+b+', 0.15)' };
}
function createBadge(entry){
  if(!entry || !entry.set || !entry.version) return null;
  const img = document.createElement('img');
  img.className = 'badge-img';
  img.src = 'https://static-cdn.jtvnw.net/badges/v1/'+entry.set+'/'+entry.version+'/1';
  img.alt = entry.set;
  img.onerror = () => img.remove();
  return img;
}
function addMessage(m){
  const colors = computeColors(m.c);
  const sameUser = lastUser === m.u && lastGroup;
  let group = lastGroup;
  if(!sameUser){
    group = document.createElement('div');
    group.className = 'msg-group user-'+sanitizeClass(m.u);
    group.style.setProperty('--user-color', colors.solid);
    group.style.setProperty('--user-color-soft', colors.soft);
    group.isConnected = true;

    const header = document.createElement('div');
    header.className = 'msg-header';
    const name = document.createElement('span');
    name.className = 'msg-username';
    name.textContent = m.u;
    name.style.color = colors.solid;
    header.appendChild(name);

    const badgesWrap = document.createElement('span');
    badgesWrap.className = 'msg-badges';
    (m.b || []).forEach(b => { const node = createBadge(b); if(node) badgesWrap.appendChild(node); });
    if(badgesWrap.children.length) header.appendChild(badgesWrap);

    const messagesDiv = document.createElement('div');
    messagesDiv.className = 'msg-messages';

    group.appendChild(header);
    group.appendChild(messagesDiv);
    container.appendChild(group);

    lastGroup = group;
    lastUser = m.u;
  }

  const messagesDiv = group.querySelector('.msg-messages');
  const line = document.createElement('div');
  line.className = 'msg-line';
  line.textContent = m.t;
  messagesDiv.appendChild(line);
}
demo.slice(-MAX_MESSAGES).forEach(addMessage);
<\/script>
</body>
</html>`;
        }

        function renderPreview() {
            const frame = document.getElementById('preview-frame');
            if (!frame) return;
            const css = (cssInput.value || '').trim() || defaultCss[currentWidget] || '';
            const max = parseInt(maxMessagesInput.value, 10) || 10;
            frame.srcdoc = getPreviewHtml(css, max);
        }

        document.getElementById('save-btn').addEventListener('click', saveWidgetConfig);
        document.getElementById('reset-btn').addEventListener('click', () => {
            cssInput.value = defaultCss[currentWidget] || '';
            setStatus('Valeurs par défaut rétablies (pense à sauvegarder)', 'ok');
            renderPreview();
        });
        document.getElementById('close-btn').addEventListener('click', () => window.close());

        cssInput.addEventListener('input', renderPreview);
        maxMessagesInput.addEventListener('input', renderPreview);

        window.api.on('load-css-editor', ({ widgetName }) => { loadWidgetConfig(widgetName).then(renderPreview); });
        document.addEventListener('DOMContentLoaded', () => { loadWidgetConfig().then(renderPreview); });
    </script>
</body>
</html>
