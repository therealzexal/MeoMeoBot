<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Editeur CSS Widget</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/css-editor.css">
</head>

<body class="css-editor-body">
    <div class="css-editor-shell">
        <div class="css-editor-titlebar">
            <h2>Apparence <span id="widgetNameLabel">du tchat</span></h2>
            <button class="css-editor-close" id="close-btn" title="Fermer">‚úï</button>
        </div>

        <div class="css-editor-main">
            <div class="css-editor-left">
                <div class="theme-selector-row">
                    <div class="theme-selector-wrapper">
                        <label for="themeSelector">Th√®mes pr√©d√©finis</label>
                        <select id="themeSelector" class="theme-selector-input">
                            <option value="">D√©faut</option>
                        </select>
                    </div>
                    <button id="importThemeBtn" class="btn btn-secondary" title="Importer un th√®me">üìÇ</button>
                    <button id="saveAsThemeBtn" class="btn btn-secondary"
                        title="Sauvegarder comme nouveau th√®me">üíæ</button>
                    <button id="editThemeConfigBtn" class="btn btn-secondary" title="Renommer les th√®mes">‚úèÔ∏è</button>
                    <button id="cssGuideBtn" class="btn btn-secondary" title="Afficher/Masquer le guide">üìñ</button>
                </div>
                <div class="css-editor-textarea-wrapper">
                    <label for="customCss">CSS Personnalis√©</label>
                    <div class="css-editor-textarea-container">
                        <textarea id="customCss" class="css-editor-textarea" spellcheck="false"></textarea>
                    </div>
                    <div id="maxMessagesRow" class="max-messages-row">
                        <label for="maxMessages">Nombre max de messages (chat)</label>
                        <input id="maxMessages" type="number" min="1" value="10" class="max-messages-input">
                    </div>
                    <div class="css-editor-actions">
                        <button class="btn btn-primary" id="save-btn">Appliquer au widget</button>
                        <button class="btn btn-secondary" id="reset-btn">Remettre par d√©faut</button>
                    </div>
                    <div class="css-editor-status" id="statusBar"></div>
                </div>
            </div>

            <div class="css-preview-block">
                <div id="preview-frame-wrapper">
                    <iframe id="preview-frame" title="widget preview"></iframe>
                </div>
            </div>

            <div id="cssGuidePanel" class="css-guide-panel" style="display: none;">
                <div class="css-guide-header">
                    <h3>Guide CSS : <span id="cssGuideWidgetName">Chat</span></h3>
                    <button id="closeCssGuideBtn" class="css-editor-close" title="Fermer le guide">‚úï</button>
                </div>
                <p class="modal-description">
                    Classes disponibles pour ce widget.
                </p>
                <div class="theme-list-container">
                    <table class="css-guide-table">
                        <thead>
                            <tr>
                                <th>Classe</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="cssGuideBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="themeConfigModal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-content-lg">
            <h3>G√©rer les noms des th√®mes</h3>
            <p class="modal-description">
                Donnez des noms plus explicites √† vos fichiers de th√®mes.
            </p>
            <div id="themeListContainer" class="theme-list-container">

            </div>
            <div class="modal-actions">
                <button id="closeThemeConfigBtn" class="btn btn-secondary">Fermer</button>
                <button id="saveThemeConfigBtn" class="btn btn-primary">Enregistrer les noms</button>
            </div>
        </div>
    </div>

    <div id="newThemeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-content-md">
            <h3>Nouveau Th√®me</h3>
            <p class="modal-description">
                Entrez le nom de votre nouveau th√®me.
            </p>
            <input type="text" id="newThemeNameInput" placeholder="Nom du th√®me" class="new-theme-input">
            <div class="modal-actions">
                <button id="cancelNewThemeBtn" class="btn btn-secondary">Annuler</button>
                <button id="confirmNewThemeBtn" class="btn btn-primary">Cr√©er</button>
            </div>
        </div>
    </div>

    <script>
        const defaultCss = {
            chat: `body {
    background: transparent;
    overflow: hidden;
    font-family: "Inter", "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
    color: white;
}

#chat-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    height: 100vh;
    padding: 10px 10px 24px 10px;
    gap: 10px;
    box-sizing: border-box;
}

.msg-group {
    padding: 10px 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    animation: fadeIn 0.4s ease-out;
    word-wrap: break-word;
}

.msg-header {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
}

.msg-username {
    font-weight: 700;
}

.msg-badges {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.badge-img {
    width: 18px;
    height: 18px;
    object-fit: contain;
}

.msg-messages {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.msg-line {
    color: #e7eef5;
    line-height: 1.4;
}

.msg-line img {
    vertical-align: middle;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(8px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}`,
            spotify: `body {
    background: transparent;
    margin: 0;
    padding: 0;
    font-family: "Inter", "Segoe UI", sans-serif;
    color: #f5f7fb;
    overflow: hidden;
}

#spotify-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100vw;
    height: 100vh;
    transition: opacity 0.35s ease;
}

#spotify-wrapper.is-hidden {
    opacity: 0;
    pointer-events: none;
}

.spotify-card {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 12px;
    padding: 14px;
    border-radius: 16px;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(8px);
    color: #f5f7fb;
    max-width: 520px;
    box-sizing: border-box;
}

.spotify-cover {
    width: 140px;
    height: 140px;
    border-radius: 12px;
    object-fit: cover;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    background: #111;
}

.spotify-infos {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.spotify-title {
    font-size: 20px;
    font-weight: 700;
    line-height: 1.2;
}

.spotify-artist {
    font-size: 16px;
    color: #cdd7e5;
}

.spotify-album {
    font-size: 14px;
    color: #9fb4d1;
}

.pill {
    align-self: flex-start;
    padding: 4px 10px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    font-size: 12px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: #d3deef;
}`,
            'emote-wall': `body {
    background: transparent;
    overflow: hidden;
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
}

.emote {
    position: absolute;
    will-change: transform, opacity;
    pointer-events: none;
}`
        };

        const cssClasses = {
            chat: [
                { class: '.msg-group', desc: 'Conteneur principal d\'un groupe de messages d\'un utilisateur' },
                { class: '.msg-header', desc: 'En-t√™te contenant le nom et les badges' },
                { class: '.msg-username', desc: 'Nom de l\'utilisateur' },
                { class: '.msg-badges', desc: 'Conteneur des badges' },
                { class: '.badge-img', desc: 'Image d\'un badge' },
                { class: '.msg-messages', desc: 'Conteneur des lignes de message' },
                { class: '.msg-line', desc: 'Une ligne de message individuelle' },
                { class: '.user-<username>', desc: 'Classe dynamique pour cibler un utilisateur sp√©cifique (ex: .user-alice)' }
            ],
            spotify: [
                { class: '#spotify-wrapper', desc: 'Conteneur principal centr√©' },
                { class: '.spotify-card', desc: 'Carte contenant la pochette et les infos' },
                { class: '.spotify-cover', desc: 'Image de la pochette d\'album' },
                { class: '.spotify-infos', desc: 'Conteneur des informations textuelles' },
                { class: '.spotify-title', desc: 'Titre du morceau' },
                { class: '.spotify-artist', desc: 'Nom de l\'artiste' },
                { class: '.spotify-album', desc: 'Nom de l\'album' },
                { class: '.pill', desc: 'Badge "En lecture"' }
            ],
            'emote-wall': [
                { class: '.emote', desc: 'Image d\'une emote flottante' }
            ]
        };

        const cssInput = document.getElementById('customCss');
        const maxMessagesInput = document.getElementById('maxMessages');
        const statusBar = document.getElementById('statusBar');
        const nameLabel = document.getElementById('widgetNameLabel');
        let currentWidget = 'chat';
        let currentWidgetConfig = {};

        function setStatus(msg, type) {
            statusBar.textContent = msg;
            statusBar.className = `css-editor-status ${type}`;
            setTimeout(() => {
                statusBar.textContent = '';
                statusBar.className = 'css-editor-status';
            }, 3000);
        }

        async function loadThemes(widget) {
            try {
                const themes = await window.api.invoke('get-themes', widget);
                const configStr = await window.api.invoke('get-theme-config');
                const config = JSON.parse(configStr || '{}');
                const selector = document.getElementById('themeSelector');
                selector.innerHTML = '<option value="">D√©faut</option>';
                themes.forEach(t => {
                    const displayName = config[t] || t.replace('.css', '');
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = displayName;
                    selector.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading themes:', e);
            }
        }

        function openConfigEditor() {
            const modal = document.getElementById('themeConfigModal');
            const container = document.getElementById('themeListContainer');
            container.innerHTML = '';

            const selector = document.getElementById('themeSelector');
            const options = Array.from(selector.options).filter(o => o.value);

            options.forEach(opt => {
                const row = document.createElement('div');
                row.className = 'theme-config-row';

                const label = document.createElement('div');
                label.className = 'theme-config-filename';
                label.textContent = opt.value;

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'theme-name-input';
                input.placeholder = 'Nom affich√©';
                input.value = opt.text === opt.value.replace('.css', '') ? '' : opt.text;
                input.dataset.filename = opt.value;

                row.appendChild(label);
                row.appendChild(input);
                container.appendChild(row);
            });

            modal.style.display = 'flex';
        }

        async function loadWidgetConfig(widgetName) {
            if (widgetName) currentWidget = widgetName;
            nameLabel.textContent = currentWidget === 'chat' ? 'du tchat' :
                currentWidget === 'spotify' ? 'de Spotify' :
                    'du mur d\'emotes';

            const maxRow = document.getElementById('maxMessagesRow');
            if (currentWidget === 'chat') {
                maxRow.style.display = 'block';
            } else {
                maxRow.style.display = 'none';
            }

            try {
                const config = await window.api.invoke('get-config');
                currentWidgetConfig = config[currentWidget] || {};

                // Load saved CSS
                const savedCss = currentWidgetConfig.customCss || '';
                cssInput.value = savedCss;

                // Load max messages for chat
                if (currentWidget === 'chat') {
                    maxMessagesInput.value = currentWidgetConfig.maxMessages || 10;
                }

                await loadThemes(currentWidget);
                renderPreview();
                updateCssGuide();
            } catch (e) {
                setStatus('Erreur chargement config: ' + e, 'err');
            }
        }

        async function saveWidgetConfig() {
            try {
                const css = cssInput.value;
                const update = { customCss: css };

                if (currentWidget === 'chat') {
                    update.maxMessages = parseInt(maxMessagesInput.value, 10) || 10;
                }

                const result = await window.api.invoke('save-widget-config', currentWidget, update);
                if (result.success) {
                    setStatus('Sauvegard√© avec succ√®s !', 'ok');
                    // Reload config to ensure sync
                    const config = await window.api.invoke('get-config');
                    currentWidgetConfig = config[currentWidget] || {};
                } else {
                    setStatus('Erreur sauvegarde', 'err');
                }
            } catch (e) {
                setStatus('Erreur: ' + e, 'err');
            }
        }

        function getChatPreviewHtml(customCss, max) {
            return `<!DOCTYPE html>
<html>
<head>
    <style>
        ${defaultCss.chat}
        ${customCss}
    </style>
</head>
<body>
    <div id="chat-container"></div>
    <script>
        const container = document.getElementById('chat-container');
        const MAX_MESSAGES = ${max};
        
        const demo = [
            { u: 'Alice', c: '#6dd4ff', b: [{ set: 'staff', version: '1' }], t: 'Hello world!' },
            { u: 'Bob', c: '#ff8b3d', b: [{ set: 'moderator', version: '1' }], t: 'Ceci est un test.' },
            { u: 'Bob', c: '#ff8b3d', b: [{ set: 'moderator', version: '1' }], t: 'Deuxieme ligne meme user.' },
            { u: 'Chloe', c: '#9b59b6', b: [], t: 'Nice overlay!' },
            { u: 'Eve', c: '#e67e22', b: [], t: 'Short msg.' }
        ];

        let lastUser = null;
        let lastGroup = null;

        function sanitizeClass(str) {
            const clean = String(str || '').toLowerCase().replace(/[^a-z0-9_-]+/g, '-').replace(/^-+|-+$/g, '');
            return clean || 'user';
        }

        function computeColors(hexColor) {
            const fallback = '#6dd4ff';
            let c = (hexColor || '').trim();
            if (!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) c = fallback;
            if (c.length === 4) c = '#' + c[1] + c[1] + c[2] + c[2] + c[3] + c[3];
            const r = parseInt(c.slice(1, 3), 16), g = parseInt(c.slice(3, 5), 16), b = parseInt(c.slice(5, 7), 16);
            return { solid: c, soft: 'rgba(' + r + ', ' + g + ', ' + b + ', 0.15)' };
        }

        function createBadge(entry) {
            if (!entry || !entry.set || !entry.version) return null;
            const img = document.createElement('img');
            img.className = 'badge-img';
            img.src = 'https://static-cdn.jtvnw.net/badges/v1/' + entry.set + '/' + entry.version + '/1';
            img.alt = entry.set;
            img.onerror = () => img.remove();
            return img;
        }

        function addMessage(m) {
            const colors = computeColors(m.c);
            const sameUser = lastUser === m.u && lastGroup;
            let group = lastGroup;

            if (!sameUser) {
                group = document.createElement('div');
                group.className = 'msg-group user-' + sanitizeClass(m.u);
                group.style.setProperty('--user-color', colors.solid);
                group.style.setProperty('--user-color-soft', colors.soft);
                
                const header = document.createElement('div');
                header.className = 'msg-header';
                
                const name = document.createElement('span');
                name.className = 'msg-username';
                name.textContent = m.u;
                name.style.color = colors.solid;
                
                header.appendChild(name);
                
                const badgesWrap = document.createElement('span');
                badgesWrap.className = 'msg-badges';
                (m.b || []).forEach(b => {
                    const node = createBadge(b);
                    if (node) badgesWrap.appendChild(node);
                });
                
                if (badgesWrap.children.length) header.appendChild(badgesWrap);
                
                const messagesDiv = document.createElement('div');
                messagesDiv.className = 'msg-messages';
                
                group.appendChild(header);
                group.appendChild(messagesDiv);
                container.appendChild(group);
                
                lastGroup = group;
                lastUser = m.u;
            }

            const messagesDiv = group.querySelector('.msg-messages');
            const line = document.createElement('div');
            line.className = 'msg-line';
            line.textContent = m.t;
            messagesDiv.appendChild(line);
        }

        demo.slice(-MAX_MESSAGES).forEach(addMessage);
    <\/script>
</body>
</html>`;
        }

        function getSpotifyPreviewHtml(customCss, cfg) {
            const safeCfg = cfg || {};
            const title = safeCfg.trackTitle || 'Mon titre';
            const artist = safeCfg.trackArtist || 'Artiste';
            const album = safeCfg.trackAlbum || 'Album';
            const cover = safeCfg.coverUrl || 'https://i.scdn.co/image/ab67616d0000b2738c0e06848d16c69ea4cbe5b7';

            return `<!DOCTYPE html>
<html>
<head>
    <style>
        ${defaultCss.spotify}
        ${customCss}
    </style>
</head>
<body>
    <div id="spotify-wrapper">
        <div class="spotify-card">
            <img class="spotify-cover" src="${cover}" alt="cover">
            <div class="spotify-infos">
                <div class="pill">En lecture</div>
                <div class="spotify-title">${title}</div>
                <div class="spotify-artist">${artist}</div>
                <div class="spotify-album">${album}</div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        function renderPreview() {
            const frame = document.getElementById('preview-frame');
            if (!frame) return;

            const css = (cssInput.value || '').trim();
            const max = parseInt(maxMessagesInput.value, 10) || 10;

            let html = '';
            if (currentWidget === 'spotify') {
                html = getSpotifyPreviewHtml(css, currentWidgetConfig);
            } else if (currentWidget === 'chat') {
                html = getChatPreviewHtml(css, max);
            } else {
                html = `<!DOCTYPE html><html><head><style>${defaultCss[currentWidget] || ''} ${css}</style></head><body><div style="color:white;padding:20px;">Aper√ßu non disponible pour ce widget</div></body></html>`;
            }

            frame.srcdoc = html;
        }

        // Event Listeners
        document.getElementById('save-btn').addEventListener('click', saveWidgetConfig);

        document.getElementById('reset-btn').addEventListener('click', () => {
            cssInput.value = ''; // Reset custom CSS
            renderPreview();
        });

        document.getElementById('close-btn').addEventListener('click', () => window.close());

        cssInput.addEventListener('input', renderPreview);
        maxMessagesInput.addEventListener('input', renderPreview);

        document.getElementById('themeSelector').addEventListener('change', async (e) => {
            const filename = e.target.value;
            if (!filename) {
                // Default theme selected
                cssInput.value = '';
                renderPreview();
                return;
            }
            try {
                const content = await window.api.invoke('get-theme-content', filename);
                cssInput.value = content;
                renderPreview();
            } catch (err) {
                alert('Erreur chargement th√®me: ' + err);
            }
        });

        document.getElementById('editThemeConfigBtn').addEventListener('click', openConfigEditor);

        document.getElementById('importThemeBtn').addEventListener('click', async () => {
            try {
                const result = await window.api.invoke('import-theme', currentWidget);
                if (result.success) {
                    setStatus(result.message, 'ok');
                    loadThemes(currentWidget);
                } else {
                    setStatus(result.message || 'Import annul√©', 'info');
                }
            } catch (error) {
                setStatus(`Erreur lors de l'importation du th√®me: ${error.message}`, 'err');
            }
        });

        // New Theme Modal Logic
        const newThemeModal = document.getElementById('newThemeModal');
        const newThemeNameInput = document.getElementById('newThemeNameInput');
        const confirmNewThemeBtn = document.getElementById('confirmNewThemeBtn');
        const cancelNewThemeBtn = document.getElementById('cancelNewThemeBtn');

        document.getElementById('saveAsThemeBtn').addEventListener('click', () => {
            newThemeNameInput.value = '';
            newThemeModal.style.display = 'flex';
            newThemeNameInput.focus();
        });

        cancelNewThemeBtn.addEventListener('click', () => {
            newThemeModal.style.display = 'none';
        });

        confirmNewThemeBtn.addEventListener('click', async () => {
            const name = newThemeNameInput.value.trim();
            if (!name) return;

            try {
                const cssContent = cssInput.value;
                const result = await window.api.invoke('create-theme', currentWidget, name, cssContent);
                if (result.success) {
                    setStatus(`Th√®me "${name}" cr√©√© avec succ√®s !`, 'ok');
                    await loadThemes(currentWidget);
                    const selector = document.getElementById('themeSelector');
                    selector.value = result.filename;
                    newThemeModal.style.display = 'none';
                }
            } catch (e) {
                setStatus('Erreur cr√©ation th√®me: ' + e, 'err');
            }
        });

        // Theme Config Modal Logic
        document.getElementById('closeThemeConfigBtn').addEventListener('click', () => {
            document.getElementById('themeConfigModal').style.display = 'none';
        });

        document.getElementById('saveThemeConfigBtn').addEventListener('click', async () => {
            try {
                const configStr = await window.api.invoke('get-theme-config');
                const fullConfig = JSON.parse(configStr || '{}');

                const inputs = document.querySelectorAll('.theme-name-input');
                inputs.forEach(input => {
                    const filename = input.dataset.filename;
                    const name = input.value.trim();
                    if (filename) {
                        if (name) {
                            fullConfig[filename] = name;
                        } else {
                            delete fullConfig[filename];
                        }
                    }
                });

                await window.api.invoke('save-theme-config', JSON.stringify(fullConfig, null, 2));
                document.getElementById('themeConfigModal').style.display = 'none';
                loadThemes(currentWidget);
                setStatus('Configuration des th√®mes sauvegard√©e', 'ok');
            } catch (e) { alert('Erreur sauvegarde: ' + e); }
        });

        // CSS Guide Logic
        const cssGuidePanel = document.getElementById('cssGuidePanel');
        const cssGuideBody = document.getElementById('cssGuideBody');
        const cssGuideWidgetName = document.getElementById('cssGuideWidgetName');
        const cssGuideBtn = document.getElementById('cssGuideBtn');

        function updateCssGuide() {
            const classes = cssClasses[currentWidget] || [];
            cssGuideWidgetName.textContent = currentWidget;
            cssGuideBody.innerHTML = classes.map(c => `
                <tr>
                    <td class="class-name">${c.class}</td>
                    <td class="description">${c.desc}</td>
                </tr>
            `).join('');
        }

        function toggleCssGuide(show) {
            const isVisible = show !== undefined ? show : cssGuidePanel.style.display === 'none';
            cssGuidePanel.style.display = isVisible ? 'flex' : 'none';
            localStorage.setItem('cssGuideVisible', isVisible);
        }

        cssGuideBtn.addEventListener('click', () => toggleCssGuide());

        document.getElementById('closeCssGuideBtn').addEventListener('click', () => toggleCssGuide(false));

        // Initialization
        window.api.on('load-css-editor', ({ widgetName }) => {
            loadWidgetConfig(widgetName).then(() => {
                renderPreview();
                updateCssGuide();
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadWidgetConfig().then(() => {
                renderPreview();
                updateCssGuide();

                // Restore guide state
                const savedState = localStorage.getItem('cssGuideVisible');
                if (savedState === 'true') {
                    toggleCssGuide(true);
                }
            });
        });
    </script>
</body>

</html>