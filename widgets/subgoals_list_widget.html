<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Subgoals List Widget</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: transparent;
            color: white;
        }

        #widget-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            /* Align list to left by default */
            padding: 20px;
            box-sizing: border-box;
        }

        .subgoals-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subgoal-item {
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subgoal-count {
            font-weight: 800;
            color: #ff00cc;
            /* Default accent color */
        }

        .subgoal-label {
            color: white;
        }

        /* __CUSTOM_CSS__ */
    </style>
</head>

<body>
    <div id="widget-container">
        <ul class="subgoals-list" id="subgoals-list">
            <!-- Items will be injected here -->
        </ul>
    </div>

    <script>
        let currentConfig = {
            steps: []
        };

        function connectWebSocket() {
            const host = window.location.hostname;
            const port = new URL(document.URL).port;
            const wsUrl = `ws://${host}:${port}`;
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Connected to Subgoals Widget Server');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'config' || data.type === 'config-update') {
                        // Accept both subgoals (for steps) and subgoals-list (for css)
                        if (data.widget === 'subgoals') {
                            if (data.config && data.config.steps) {
                                currentConfig.steps = data.config.steps;
                                render();
                            }
                        } catch (e) {
                            console.error('Error parsing WS message', e);
                        }
                    };

                    ws.onclose = () => {
                        console.log('Disconnected. Reconnecting in 5s...');
                        setTimeout(connectWebSocket, 5000);
                    };

                    ws.onerror = (err) => {
                        console.error('WebSocket error', err);
                        ws.close();
                    };
                }

        function render() {
                    const list = document.getElementById('subgoals-list');
                    list.innerHTML = '';

                    const { steps } = currentConfig;

                    if (steps && Array.isArray(steps)) {
                        // Sort by count
                        const sortedSteps = [...steps].sort((a, b) => parseFloat(a.count) - parseFloat(b.count));

                        sortedSteps.forEach(step => {
                            const li = document.createElement('li');
                            li.className = 'subgoal-item';

                            const countSpan = document.createElement('span');
                            countSpan.className = 'subgoal-count';
                            countSpan.textContent = `+${step.count}`;

                            const labelSpan = document.createElement('span');
                            labelSpan.className = 'subgoal-label';
                            labelSpan.textContent = `: ${step.label}`;

                            li.appendChild(countSpan);
                            li.appendChild(labelSpan);
                            list.appendChild(li);
                        });
                    }
                }

                connectWebSocket();
    </script>
</body>

</html>