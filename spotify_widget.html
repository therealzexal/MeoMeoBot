<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Spotify Now Playing</title>
    <style>
        body {
            background: transparent;
            margin: 0;
            padding: 0;
            font-family: "Inter","Segoe UI",sans-serif;
            color: #f5f7fb;
            overflow: hidden;
        }
        #spotify-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            transition: opacity 0.35s ease;
        }
        #spotify-wrapper.is-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spotify-card {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 12px;
            padding: 14px;
            border-radius: 16px;
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 15px 40px rgba(0,0,0,0.45);
            backdrop-filter: blur(8px);
            color: #f5f7fb;
            max-width: 520px;
            box-sizing: border-box;
        }
        .spotify-cover {
            width: 140px;
            height: 140px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            background: #111;
        }
        .spotify-infos {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .spotify-title {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.2;
        }
        .spotify-artist {
            font-size: 16px;
            color: #cdd7e5;
        }
        .spotify-album {
            font-size: 14px;
            color: #9fb4d1;
        }
        .pill {
            align-self: flex-start;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #d3deef;
        }
    </style>
    <style>
/* CUSTOM_CSS_PLACEHOLDER */
    </style>
</head>
<body>
<div id="spotify-wrapper">
    <div class="spotify-card">
        <img id="spotifyCover" class="spotify-cover" alt="Cover">
        <div class="spotify-infos">
            <div class="pill">En lecture</div>
            <div id="spotifyTitle" class="spotify-title">Titre du morceau</div>
            <div id="spotifyArtist" class="spotify-artist">Artiste</div>
            <div id="spotifyAlbum" class="spotify-album">Album</div>
        </div>
    </div>
</div>

<script>
const INITIAL_CONFIG = {};
const FALLBACK_COVER = 'https://i.scdn.co/image/ab67616d0000b2738c0e06848d16c69ea4cbe5b7';

let ws = null;
let currentConfig = INITIAL_CONFIG || {};

function applyConfig(cfg) {
    const safe = cfg || {};
    const cover = document.getElementById('spotifyCover');
    const title = document.getElementById('spotifyTitle');
    const artist = document.getElementById('spotifyArtist');
    const album = document.getElementById('spotifyAlbum');
    const wrapper = document.getElementById('spotify-wrapper');

    if (cover) cover.src = safe.coverUrl || FALLBACK_COVER;
    if (title) title.textContent = safe.trackTitle || 'Titre du morceau';
    if (artist) artist.textContent = safe.trackArtist || 'Artiste';
    if (album) album.textContent = safe.trackAlbum || 'Album';

    const isPlaying = safe.isPlaying !== false && !!(safe.trackTitle || safe.trackArtist || safe.coverUrl);
    if (wrapper) {
        wrapper.classList.toggle('is-hidden', !isPlaying);
    }
}

function connectWebSocket() {
    const host = window.location.hostname;
    const port = new URL(document.URL).port;
    const wsUrl = `ws://${host}:${port}`;
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        if (currentConfig) applyConfig(currentConfig);
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'config-update' && data.widget === 'spotify') {
                currentConfig = data.config || currentConfig;
                applyConfig(currentConfig);
            }
        } catch (err) {
            console.warn('Spotify widget message parse error', err);
        }
    };

    ws.onclose = () => setTimeout(connectWebSocket, 4000);
    ws.onerror = () => { try { ws.close(); } catch(e) {} };
}

applyConfig(currentConfig);
connectWebSocket();
</script>
</body>
</html>
